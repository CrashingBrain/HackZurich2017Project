<link rel="import" href="/polymer/polymer.html">
<link rel="import" href="/css/shared-style.html">


<!-- Polymer components -->
<link rel="import" href="/google-map/google-map.html"></link>
<link rel="import" href="/google-map/google-map-marker.html"></link>
<!-- Custom scripts -->

<script src="../js/ajax.js"></script>

<dom-module id="nepeta-room-resources">
  <template>
    <style is="custom-style" include="shared-style">
      :host {
        display: block;
        flex: 1;
        padding-bottom: 5%;
        background-color: green;
      }

      .news-context-wrapper {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: flex-start;
        margin: 2% 2% 0 2%;
      }

      tag-tag {
        padding: 5px;
        margin: 2px;
        color: white;
        background-color: black;
      }

      .news-article {
        margin: 2% 2% 0 2%;
        padding: 10px;
        border-radius: 2px;
        background-color: red;
        color: white;
      }

      google-map {
        height: 300px;
        width: 400px;
      }

      #map {
        height: 400px;
        width: 100%;
       }
    </style>

    <div class="news-context-wrapper">
      <span>
      <!-- <div id="map"></div> -->
      <google-map id="map" latitude="[[lat]]" longitude="[[lon]]">
        <google-map-marker latitude="[[lat]]" longitude="[[lon]]"></google-map-marker>
      </google-map>
      </span>
      <span>
        Here goes people
        <template is="dom-repeat" items="{{people}}" as="person">
          <tag-tag>#{{person}}</tag-tag>
        </template>
      </span>
    </div>

  </template>

  <script>
    Polymer({
      is : 'nepeta-room-resources',

      properties: {
        MainStory: {
          type: String // this being the id of the main story
        },
        location: {
          type: String
        },
        people: {
          type: Array,
          value: [],
          reflectToAttribute: true,
        },
        lat: {
          type: Number,
          // observer: "latObserver"
        },
        lon: {
          type: Number,
          // observer: "lonObserver"
        }
      },

      attached: function() {
        // this.getCoordinates();
        this.initMap();
        this.getPeople();
      },

      getCoordinates: function(){
        var coordurl = "http://maps.googleapis.com/maps/api/geocode/json?address=" + this.location + "&sensor=false";
        ajaxRequest('GET', coordurl, null, null, function(err, response){
          if (err){
            console.log('Error obtaining location on the map.');
          } else if (response){
            this.set('lat', response.results.geometry.location.lat);
            this.set('lon', response.results.geometry.location.lon);
          }
        });
      }

      getPeople: function(){
        ajaxRequest('GET', '/' + this.MainStory + '/people', null, null, (err, people)=>{
          if (err){
            console.log('something something something');
          } else if (people){
            for (let person of people){
              (person) => {
                let url = "https://en.wikipedia.org/w/api.php?format=json&action=query&prop=extracts&exintro=&explaintext=&titles=" + person + "&redirects=1";
                ajaxRequest('GET', url, null, null, function(err, extract){
                  if (err){
                    console.log('impossible to get person infos.');
                  } else {
                    // let text = extract.query.pages;
                    for (var key in extract.query.pages) {
                      if (extract.query.pages.hasOwnProperty(key)) {
                        console.log(key); 
                        console.log(object[key]); 
                      }
                    }
                    // let personextract = {"name": person, "extract": text};
                    // this.push('people', personextract);
                  }
                });
              }
            }
          }
        });
      },

      latObserver: function(){
        let map = document.getElementById('map');
        map.latitude = this.lat;
      },
      lonObserver: function(){
        let map = document.getElementById('map');
        map.longitude = this.lon;
      },
      initMap: function() {
        var uluru = {lat: -25.363, lng: 131.044};
        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 4,
          center: uluru
        });
        var marker = new google.maps.Marker({
          position: uluru,
          map: map
        });
      }

    });
  </script>
<!--   <script>
      function initMap() {
        var uluru = {lat: -25.363, lng: 131.044};
        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 4,
          center: uluru
        });
        var marker = new google.maps.Marker({
          position: uluru,
          map: map
        });
      }
    </script> -->
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAHqbpU4WBb9qjPE7PtHnMqsyNqFfpxIRc&callback=initMap">
    </script>
</dom-module>
