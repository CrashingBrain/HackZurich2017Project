<link rel="import" href="/polymer/polymer.html">
<link rel="import" href="/css/shared-style.html">
<script src="../js/ajax.js"></script>

<!-- Polymer Components -->
<link rel="import" href="/elements/nepeta-post.html"></link>
<link rel="import" href="/paper-input/paper-input.html"></link>
<link rel="import" href="/paper-input/paper-textarea.html"></link>
<link rel="import" href="/paper-button/paper-button.html"></link>


<dom-module id="nepeta-room-posts">
  <template>
    <style is="custom-style" include="shared-style">
      :host {
        display: block;
        flex: 1;
        background-color: blue;
        color: yellow;
      }

      #wrapper {
        position: relative;
        display: block;
      }

      #new-post {
        position: relative;
        padding: 15px;
      }

      #noposts {
        position: relative;
        display: block;
        width: 100%;
        text-align: center;
      }
    </style>

    <div id="wrapper">
      <div id="new-post">
        <paper-input id="username" label="username"></paper-input>
        <paper-textarea id="message" label="message"></paper-textarea>
        <paper-button raised class="blue" on-click="_postMessage">post</paper-button>
      </div>

      <p id="noposts">No posts yet!</p>

      <div id="parentposts">
        <!-- posts -->
      </div>
    </div>

  </template>

  <script>
    Polymer({
      is : 'nepeta-room-posts',

      properties: {
        posts: {
          type: Array,
          default: [],
          reflectToAttribute: true,
        },
        roomid: {
          type: String,
        }
      },

      attached: function() {

        // this.posts = [{
        //   username : "one",
        //   message : "hello1",
        //   date : Date.now(),
        //   replies : [{
        //     username : "one.one",
        //     message : "hello1.1",
        //     date : Date.now(),
        //     replies : [],
        //   },{
        //     username : "one.two",
        //     message : "hello1.2",
        //     date : Date.now(),
        //     replies : [{
        //       username : "one.two.one",
        //       message : "hello1.2.1",
        //       date : Date.now(),
        //       replies : [{
        //         username : "one.two.one.one",
        //         message : "hello1.2.1.1",
        //         date : Date.now(),
        //         replies : [{
        //           username : "one.two.one.one.one",
        //           message : "hello1.2.1.1.1",
        //           date : Date.now(),
        //           replies : [],
        //         }],
        //       }],
        //     }],
        //   }],
        // },{
        //   username : "two",
        //   message : "hello2",
        //   date : Date.now(),
        //   replies : [],
        // },{
        //   username : "three",
        //   message : "hello3",
        //   date : Date.now(),
        //   replies : [{
        //     username : "three.one",
        //     message : "hello3.1",
        //     date : Date.now(),
        //     replies : [],
        //   },{
        //     username : "three.two",
        //     message : "hello3.2",
        //     date : Date.now(),
        //     replies : [],
        //   },{
        //     username : "three.three",
        //     message : "hello3.3",
        //     date : Date.now(),
        //     replies : [],
        //   }],
        // },{
        //   username : "four",
        //   message : "hello4",
        //   date : Date.now(),
        //   replies : [{
        //     username : "four.one",
        //     message : "hello4.1",
        //     date : Date.now(),
        //     replies : [],
        //   }],
        // }];

        if (this.posts.length === 0) {
          this.$.noposts.style.display = "block";
          return;
        }
        else {
          this.$.noposts.style.display = "none";
        }

        for (var post of this.posts) {
          var dom_post = document.createElement('nepeta-post');
          dom_post.username = post.username;
          dom_post.message = post.message;
          dom_post.date = post.date;
          if (post.replies && post.replies.length > 0) {
            for (var reply of post.replies) {
              var dom_reply = this._createDOMPost(reply);
              dom_post.appendChild(dom_reply);
            }
          }

          this.$.parentposts.appendChild(dom_post);
        }
      },

      _createDOMPost: function(post) {
        var dom_post = document.createElement('nepeta-post');
        dom_post.username = post.username;
        dom_post.message = post.message;
        dom_post.date = post.date;
        if (post.replies && post.replies.length > 0) {
          for (var reply of post.replies) {
            var dom_reply = this._createDOMPost(reply);
            dom_post.appendChild(dom_reply);
          }
        }
        return dom_post;
      },

      _postMessage: function() {
        let post_username = this.$.username.value;
        let post_message = this.$.message.value;
        if (!post_message) alert("no message");
        else {
          /* create new post */
          var newpost = {
            message:  post_message,
            date:     Date.now(),
          };
          if (post_username) newpost.username = post_username;

          /* post message and display */
          ajaxRequest('POST', '/room/' + this.roomid, {}, newpost, function(res) {
            console.log(res);
            var created_post = this._createDOMPost(res);
            this.$.parentposts.insertBefore(
              created_post,
              this.$.parentposts.firstChild
            );
          }.bind(this));
        }
      },
    });
  </script>
</dom-module>
